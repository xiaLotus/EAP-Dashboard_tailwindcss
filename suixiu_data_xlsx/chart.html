<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¯å°æ™‚å¦¥å–„ç‡ç›£æ§</title>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        [v-cloak] {
            display: none;
        }
        
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }
        
        #app {
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
        }
        
        .data-table {
            table-layout: fixed;
            width: 100%;
        }
        
        .data-table th,
        .data-table td {
            padding: 0.5rem;
            font-size: 0.875rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>

<body class="bg-gray-50">
    <div id="app" v-cloak>
        
        <!-- Loading State -->
        <div v-if="loading" class="flex items-center justify-center h-screen">
            <div class="text-center">
                <div class="inline-block animate-spin rounded-full h-16 w-16 border-b-4 border-blue-500 mb-4"></div>
                <p class="text-gray-600 text-lg font-semibold">è¼‰å…¥æ•¸æ“šä¸­...</p>
            </div>
        </div>

        <!-- Error State -->
        <div v-else-if="error" class="flex items-center justify-center h-screen">
            <div class="bg-red-50 border-2 border-red-500 rounded-xl p-8 max-w-md">
                <div class="text-red-600 text-6xl mb-4 text-center">âš ï¸</div>
                <h2 class="text-2xl font-bold text-red-900 mb-2 text-center">è¼‰å…¥å¤±æ•—</h2>
                <p class="text-red-700 mb-4 text-center">{{ error }}</p>
                <button @click="manualRefresh" 
                        class="w-full px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-semibold transition-all">
                    é‡æ–°è¼‰å…¥
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div v-show="!loading && !error" class="flex flex-col h-screen">
            
            <!-- Header -->
            <div class="bg-white shadow-sm border-b-2 border-gray-200 px-6 py-4 flex-shrink-0">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <h1 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
                            <span>ğŸ“Š</span>
                            <span>æ¯å°æ™‚å¦¥å–„ç‡ç›£æ§</span>
                            <span class="text-sm font-normal text-gray-600">{{ currentTime }}</span>
                        </h1>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                            1/10 20:00 ~ 1/11 12:00
                        </span>
                        <div class="px-3 py-2 bg-green-50 border-2 border-green-500 rounded-lg">
                            <span class="text-green-900 font-semibold text-sm flex items-center gap-2">
                                <span class="inline-block w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                                è‡ªå‹•åˆ·æ–°
                            </span>
                        </div>
                        <button @click="manualRefresh" 
                                :disabled="isRefreshing"
                                class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-semibold transition-all flex items-center gap-2 disabled:opacity-50">
                            <span>ğŸ”„</span>
                            <span v-if="isRefreshing">åˆ·æ–°ä¸­...</span>
                            <span v-else>åˆ·æ–°</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="flex-1 flex flex-col px-6 py-4 gap-4 overflow-hidden">
                
                <!-- Chart Section -->
                <div class="bg-white rounded-xl shadow-sm border-2 border-gray-200 p-4 flex-1 flex flex-col overflow-hidden">
                    <div class="flex items-center justify-between mb-3 flex-shrink-0">
                        <h2 class="text-xl font-bold text-gray-900">ğŸ“ˆ å¦¥å–„ç‡è¶¨å‹¢åœ–</h2>
                        <div class="flex gap-4">
                            <div class="flex items-center gap-2">
                                <div class="w-6 h-1 bg-blue-500 rounded"></div>
                                <span class="text-sm font-semibold text-gray-700">K11</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-6 h-1 bg-green-500 rounded"></div>
                                <span class="text-sm font-semibold text-gray-700">K22</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex-1 relative">
                        <canvas ref="chartCanvas"></canvas>
                    </div>
                </div>

                <!-- Table Section -->
                <div class="bg-white rounded-xl shadow-sm border-2 border-gray-200 p-4 flex-1 flex flex-col overflow-hidden">
                    <h2 class="text-xl font-bold text-gray-900 mb-3 flex-shrink-0">ğŸ“‹ å¦¥å–„ç‡æ•¸æ“š</h2>
                    <div class="flex-1 overflow-hidden">
                        <table class="data-table border-collapse w-full h-full">
                            <thead>
                                <tr class="bg-gradient-to-r from-blue-500 to-blue-600">
                                    <th class="border border-blue-400 text-white font-semibold text-sm" style="width: 80px;"></th>
                                    <th v-for="(label, index) in timeLabels" :key="index"
                                        class="border border-blue-400 text-white text-center">
                                        <div class="text-xs opacity-90">{{ label.date }}</div>
                                        <div class="text-sm font-bold">{{ label.time }}</div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- K11 Row -->
                                <tr class="hover:bg-blue-50 transition-colors">
                                    <td class="border border-gray-300 bg-gradient-to-r from-blue-100 to-blue-200 font-bold text-gray-900 text-center">
                                        K11
                                    </td>
                                    <td v-for="(value, index) in k11Data" :key="'k11-' + index"
                                        class="border border-gray-300 text-center font-semibold"
                                        :class="getValueClass(value)">
                                        {{ formatValue(value) }}
                                    </td>
                                </tr>

                                <!-- K22 Row -->
                                <tr class="hover:bg-green-50 transition-colors">
                                    <td class="border border-gray-300 bg-gradient-to-r from-green-100 to-green-200 font-bold text-gray-900 text-center">
                                        K22
                                    </td>
                                    <td v-for="(value, index) in k22Data" :key="'k22-' + index"
                                        class="border border-gray-300 text-center font-semibold"
                                        :class="getValueClass(value)">
                                        {{ formatValue(value) }}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>

        </div>

    </div>

    <script>
        const app = Vue.createApp({
            data() {
                return {
                    // é…ç½®
                    apiUrl: 'http://127.0.0.1:5000/api/hourly_rate',
                    refreshInterval: 30000,
                    
                    // çŠ¶æ€
                    chart: null,
                    currentTime: '',
                    loading: true,
                    error: '',
                    isRefreshing: false,
                    
                    // æ•°æ® - å›ºå®š17ä¸ªå…ƒç´  (20:00~12:00)
                    k11Data: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    k22Data: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    
                    // æ—¶é—´æ ‡ç­¾ - ç¼“å­˜åœ¨dataä¸­
                    timeLabels: [],
                    
                    // å®šæ—¶å™¨
                    refreshTimer: null,
                    timeTimer: null
                };
            },
            
            methods: {
                // æ›´æ–°æ—¶é—´
                updateTime() {
                    const now = new Date();
                    this.currentTime = now.toLocaleString('zh-TW', {
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                },
                
                // æ ¼å¼åŒ–å€¼
                formatValue(value) {
                    if (value === null || value === undefined) return '--';
                    return value.toFixed(2) + '%';
                },
                
                // è·å–å€¼çš„æ ·å¼ç±»
                getValueClass(value) {
                    if (value === null || value === undefined) return 'text-gray-400';
                    if (value < 80) return 'text-red-600 bg-red-50';
                    return 'text-green-600 bg-green-50';
                },
                
                // ç”Ÿæˆæ—¶é—´æ ‡ç­¾ï¼ˆåªè°ƒç”¨ä¸€æ¬¡ï¼‰
                generateTimeLabels() {
                    const labels = [];
                    const startDate = new Date(2026, 0, 10, 20, 0);
                    
                    for (let i = 0; i < 17; i++) {
                        const t = new Date(startDate);
                        t.setHours(startDate.getHours() + i);
                        labels.push({
                            date: `${t.getMonth() + 1}/${t.getDate()}`,
                            time: `${String(t.getHours()).padStart(2, '0')}:00`
                        });
                    }
                    
                    this.timeLabels = labels;
                    console.log('âœ… æ™‚é–“æ¨™ç±¤å·²ç”Ÿæˆ');
                },
                
                // åˆå§‹åŒ–å›¾è¡¨
                initChart() {
                    if (!this.$refs.chartCanvas) {
                        console.error('âŒ Canvasä¸å­˜åœ¨');
                        return;
                    }

                    try {
                        const ctx = this.$refs.chartCanvas.getContext('2d');
                        
                        this.chart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: this.timeLabels.map(l => l.time),
                                datasets: [
                                    {
                                        label: 'K11',
                                        data: this.k11Data,
                                        borderColor: '#3b82f6',
                                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                        tension: 0.4,
                                        borderWidth: 3,
                                        pointRadius: 6,
                                        pointBackgroundColor: '#3b82f6',
                                        pointBorderColor: '#fff',
                                        pointBorderWidth: 2
                                    },
                                    {
                                        label: 'K22',
                                        data: this.k22Data,
                                        borderColor: '#10b981',
                                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                        tension: 0.4,
                                        borderWidth: 3,
                                        pointRadius: 6,
                                        pointBackgroundColor: '#10b981',
                                        pointBorderColor: '#fff',
                                        pointBorderWidth: 2
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: false },
                                    tooltip: {
                                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                        padding: 12,
                                        callbacks: {
                                            label: (context) => {
                                                return context.dataset.label + ': ' + 
                                                       (context.parsed.y !== null ? context.parsed.y.toFixed(2) + '%' : 'N/A');
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        min: 0,
                                        max: 100,
                                        ticks: {
                                            callback: v => v + '%',
                                            font: { size: 14, weight: '600' }
                                        }
                                    },
                                    x: {
                                        ticks: { font: { size: 13 } }
                                    }
                                }
                            }
                        });

                        console.log('âœ… åœ–è¡¨åˆå§‹åŒ–å®Œæˆ');
                    } catch (err) {
                        console.error('âŒ åœ–è¡¨åˆå§‹åŒ–å¤±æ•—:', err);
                    }
                },
                
                // æ›´æ–°å›¾è¡¨ - ç®€åŒ–ç‰ˆ
                updateChart() {
                    if (!this.chart) {
                        console.warn('âš ï¸ Chartä¸å­˜åœ¨ï¼Œè·³éæ›´æ–°');
                        return;
                    }
                    
                    try {
                        // ç›´æ¥æ›´æ–°æ•°æ®ï¼Œä¸åˆ›å»ºæ–°æ•°ç»„
                        this.chart.data.datasets[0].data = this.k11Data;
                        this.chart.data.datasets[1].data = this.k22Data;
                        this.chart.update('none');
                        console.log('âœ… åœ–è¡¨å·²æ›´æ–°');
                    } catch (err) {
                        console.error('âŒ åœ–è¡¨æ›´æ–°å¤±æ•—:', err);
                    }
                },
                
                // æ‰‹åŠ¨åˆ·æ–°
                manualRefresh() {
                    console.log('ğŸ–±ï¸ æ‰‹å‹•åˆ·æ–°');
                    this.loadData();
                },
                
                // ä»APIåŠ è½½æ•°æ®
                async loadData() {
                    // é˜²æ­¢é‡å¤
                    if (this.isRefreshing) {
                        console.log('â¸ï¸ è·³éï¼ˆæ­£åœ¨åˆ·æ–°ä¸­ï¼‰');
                        return;
                    }
                    
                    this.isRefreshing = true;
                    console.log('ğŸ”„ é–‹å§‹è¼‰å…¥...');
                    
                    try {
                        const response = await fetch(this.apiUrl);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                        
                        const data = await response.json();
                        console.log('ğŸ“¦ æ”¶åˆ°æ•¸æ“š:', data);
                        
                        // å…ˆæ¸…ç©ºæ‰€æœ‰æ•¸æ“š
                        for (let i = 0; i < 17; i++) {
                            this.k11Data[i] = null;
                            this.k22Data[i] = null;
                        }
                        
                        // å¦‚æœå¾Œç«¯è¿”å›çš„æ˜¯å¸¶æ™‚é–“æˆ³è¨˜çš„è³‡æ–™
                        if (data.timestamps && Array.isArray(data.timestamps)) {
                            // è™•ç†å¸¶æ™‚é–“æˆ³è¨˜çš„è³‡æ–™
                            data.timestamps.forEach((timestamp, idx) => {
                                const date = new Date(timestamp);
                                const hour = date.getHours();
                                
                                // è¨ˆç®—åœ¨17å°æ™‚æ™‚é–“è»¸ä¸­çš„ä½ç½® (20:00æ˜¯ç´¢å¼•0)
                                let position = -1;
                                if (hour >= 20) {
                                    position = hour - 20; // 20:00â†’0, 21:00â†’1, 22:00â†’2, 23:00â†’3
                                } else if (hour <= 12) {
                                    position = hour + 4; // 00:00â†’4, 01:00â†’5, ..., 12:00â†’16
                                }
                                
                                if (position >= 0 && position < 17) {
                                    this.k11Data[position] = data.k11[idx] || null;
                                    this.k22Data[position] = data.k22[idx] || null;
                                }
                            });
                        } else {
                            // å‘å¾Œå…¼å®¹ï¼šå¦‚æœå¾Œç«¯æ²’æœ‰timestampsï¼Œå‡è¨­æ˜¯é †åºè³‡æ–™å¾22:00é–‹å§‹
                            if (data.k11 && Array.isArray(data.k11)) {
                                for (let i = 0; i < 15; i++) {
                                    this.k11Data[i + 2] = data.k11[i] || null; // å¾ç´¢å¼•2é–‹å§‹ (22:00)
                                }
                            }
                            
                            if (data.k22 && Array.isArray(data.k22)) {
                                for (let i = 0; i < 15; i++) {
                                    this.k22Data[i + 2] = data.k22[i] || null;
                                }
                            }
                        }
                        
                        // æ›´æ–°å›¾è¡¨
                        this.updateChart();
                        
                        this.error = '';
                        this.loading = false;
                        
                        console.log('âœ… è¼‰å…¥æˆåŠŸ');
                        
                    } catch (err) {
                        console.error('âŒ è¼‰å…¥å¤±æ•—:', err);
                        this.error = `${err.message}`;
                        this.loading = false;
                    }
                    
                    // å»¶è¿Ÿé‡Šæ”¾é”
                    setTimeout(() => {
                        this.isRefreshing = false;
                        console.log('ğŸ”“ å·²é‡‹æ”¾é–');
                    }, 1000);
                },
                
                // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
                startAutoRefresh() {
                    if (this.refreshTimer) {
                        clearInterval(this.refreshTimer);
                    }
                    
                    this.refreshTimer = setInterval(() => {
                        console.log('â° è‡ªå‹•åˆ·æ–°');
                        this.loadData();
                    }, this.refreshInterval);
                    
                    console.log(`â° è‡ªå‹•åˆ·æ–°å•Ÿå‹•ï¼ˆ${this.refreshInterval / 1000}ç§’ï¼‰`);
                },
                
                // åœæ­¢è‡ªåŠ¨åˆ·æ–°
                stopAutoRefresh() {
                    if (this.refreshTimer) {
                        clearInterval(this.refreshTimer);
                        this.refreshTimer = null;
                    }
                }
            },
            
            async mounted() {
                console.log('ğŸš€ é–‹å§‹æ›è¼‰');
                
                // ç”Ÿæˆæ—¶é—´æ ‡ç­¾ï¼ˆåªè°ƒç”¨ä¸€æ¬¡ï¼‰
                this.generateTimeLabels();
                
                // å¯åŠ¨æ—¶é—´æ›´æ–°
                this.updateTime();
                this.timeTimer = setInterval(() => this.updateTime(), 1000);
                
                // åŠ è½½æ•°æ®
                await this.loadData();
                
                // ç­‰å¾…DOM
                await this.$nextTick();
                await this.$nextTick();
                
                // åˆå§‹åŒ–å›¾è¡¨
                if (this.$refs.chartCanvas) {
                    this.initChart();
                    this.startAutoRefresh();
                    console.log('ğŸ“Š ç³»çµ±å•Ÿå‹•å®Œæˆ');
                }
            },
            
            beforeUnmount() {
                console.log('ğŸ‘‹ é–‹å§‹å¸è¼‰');
                
                this.stopAutoRefresh();
                
                if (this.timeTimer) {
                    clearInterval(this.timeTimer);
                }
                
                if (this.chart) {
                    this.chart.destroy();
                    this.chart = null;
                }
            }
        });
        
        app.mount('#app');
    </script>
</body>
</html>