<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Suixiu Viewer Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    
    * {
      font-family: 'Inter', sans-serif;
    }
    
    .line-clip-1 { 
      white-space: nowrap; 
      overflow: hidden; 
      text-overflow: ellipsis; 
    }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(230, 230, 230, 0.3);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
    }
    
    .progress-circle {
      transition: stroke-dashoffset 2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .fade-in {
      animation: fadeIn 0.8s ease-out forwards;
    }
    
    .slide-up {
      animation: slideUp 0.6s ease-out forwards;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .pulse-animation {
      animation: pulse 2s ease-in-out infinite;
    }
    
    .status-badge {
      transition: all 0.3s ease;
      transform: scale(0.9);
    }
    
    .status-badge:hover {
      transform: scale(1);
    }
    
    .card-hover {
      transition: all 0.3s ease;
    }
    
    .card-hover:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    }
    
    .gradient-bg {
      background: linear-gradient(135deg, #fefbf3 0%, #f7f3e9 50%, #f1ede4 100%);
    }
    
    .table-row {
      transition: all 0.2s ease;
      border-bottom: 1px solid rgba(200, 200, 200, 0.3);
    }
    
    .table-row:hover {
      background: rgba(248, 250, 252, 0.6);
      transform: translateX(4px);
    }
    
    .loading-spinner {
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .glow-effect {
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
    }
    
    .glow-effect-yellow {
      box-shadow: 0 0 20px rgba(250, 204, 21, 0.3);
    }
    
    .glow-effect-red {
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
    }

    .floor-progress-bar {
      transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1);
    }
  </style>
</head>
<body class="gradient-bg text-gray-800 min-h-screen">
  <div id="app" class="min-h-screen p-4 md:p-8">
    
    <!-- 左上角返回按鈕 -->
    <div class="fixed top-4 left-4 z-50">
      <button @click="goBack" 
              class="flex items-center gap-2 px-4 py-2 glass-card rounded-xl hover:bg-white/80 transition-all duration-300 transform hover:scale-105 shadow-lg text-gray-700 font-medium">
        <i data-lucide="arrow-left" class="w-5 h-5"></i>
        <span class="hidden md:inline">返回上頁</span>
      </button>
    </div>

    <!-- 右上角手動重新載入按鈕 -->
    <div class="fixed top-4 right-4 z-50">
      <button @click="manualReload" 
              :disabled="manualLoading"
              class="flex items-center gap-2 px-4 py-2 glass-card rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg text-gray-700 font-medium"
              :class="{
                'hover:bg-white/80 cursor-pointer': !manualLoading,
                'opacity-75 cursor-not-allowed': manualLoading
              }">
        <i :data-lucide="manualLoading ? 'loader-2' : 'refresh-cw'" 
           :class="{'animate-spin': manualLoading}" 
           class="w-5 h-5"></i>
        <span class="hidden md:inline">{{ manualLoading ? '載入中...' : '重新載入' }}</span>
      </button>
    </div>

    <!-- 標題區域 -->
    <div class="text-center mb-12 fade-in">
      <h1 class="text-5xl md:text-6xl font-bold bg-gradient-to-r from-amber-600 via-orange-500 to-red-500 bg-clip-text text-transparent mb-4">
        歲修 Dashboard
      </h1>
      <p class="text-xl text-gray-600">實時監控系統狀態</p>
      <div class="w-24 h-1 bg-gradient-to-r from-amber-500 to-orange-500 mx-auto mt-4 rounded-full"></div>
    </div>

    <!-- 載入/錯誤狀態 -->
    <div v-if="loading" class="flex flex-col items-center justify-center py-20 text-gray-600">
      <div class="loading-spinner w-12 h-12 border-4 border-amber-500 border-t-transparent rounded-full mb-4"></div>
      <div class="text-xl">載入中...</div>
    </div>
    
    <div v-else-if="error" class="flex flex-col items-center justify-center py-20 gap-4">
      <div class="text-6xl mb-4">⚠️</div>
      <div class="text-red-600 text-xl text-center">{{ error }}</div>
      <button @click="reload" class="flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-xl hover:from-amber-600 hover:to-orange-600 transition-all duration-300 transform hover:scale-105 shadow-lg">
        <i data-lucide="rotate-ccw" class="w-5 h-5"></i> 重新載入
      </button>
    </div>

    <template v-else>
      <!-- 切換按鈕 -->
      <div class="text-center mb-8">
         <div class="flex justify-center gap-4">
          <button @click="toggleFloorView" 
                  class="inline-flex items-center gap-2 px-6 py-3 glass-card rounded-xl hover:bg-white/60 transition-all duration-300 transform hover:scale-105 shadow-lg">
            <i :data-lucide="showEachFloor ? 'pie-chart' : 'bar-chart-3'" class="w-5 h-5"></i>
            {{ showEachFloor ? '顯示總覽圖表' : '顯示各樓層詳情' }}
          </button>
          <button @click="goToPostingRateDetail"
                  class="inline-flex items-center gap-2 px-6 py-3 glass-card rounded-xl hover:bg-white/60 transition-all duration-300 transform hover:scale-105 shadow-lg">
            <i data-lucide="arrow-right-circle" class="w-5 h-5"></i>
            跳轉 過帳率詳情
          </button>
        </div>
      </div>

      <!-- 圓形進度圖表區域 -->
      <div v-if="!showEachFloor" class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-16 fade-in">
        
        <!-- F1 進度圓 -->
        <div class="flex flex-col items-center slide-up">
          <div class="glass-card rounded-2xl p-8 card-hover w-full max-w-md"
               :class="{
                 'glow-effect': F1_EAP_Success_Rate > 80,
                 'glow-effect-yellow': F1_EAP_Success_Rate > 60 && F1_EAP_Success_Rate <= 80,
                 'glow-effect-red': F1_EAP_Success_Rate <= 60
               }">
            <h2 class="text-3xl font-bold mb-6 text-center bg-gradient-to-r from-blue-600 to-cyan-600 bg-clip-text text-transparent">F1</h2>
            <div class="relative w-64 h-64 mx-auto mb-4">
              <svg class="w-full h-full transform -rotate-90" viewBox="0 0 256 256">
                <circle class="text-gray-300" stroke-width="16" stroke="currentColor" fill="none" cx="128" cy="128" r="110"/>
                <circle 
                  class="progress-circle"
                  :class="{
                    'text-red-500': F1_EAP_Success_Rate <= 60,
                    'text-yellow-400': F1_EAP_Success_Rate > 60 && F1_EAP_Success_Rate <= 80,
                    'text-green-400': F1_EAP_Success_Rate > 80
                  }"
                  stroke-width="16" 
                  stroke-linecap="round" 
                  stroke="currentColor" 
                  fill="none"
                  cx="128" cy="128" r="110"
                  :stroke-dasharray="2 * Math.PI * 110"
                  :stroke-dashoffset="(2 * Math.PI * 110) * (1 - F1_EAP_Success_Rate / 100)"/>
              </svg>
              <div class="absolute inset-0 flex flex-col items-center justify-center">
                <div class="text-4xl font-black text-gray-800">{{ F1_EAP_Success_Rate }}%</div>
                <div class="text-sm text-gray-600 mt-1">成功率</div>
              </div>
            </div>
          </div>
        </div>

        <!-- F3 進度圓 -->
        <div class="flex flex-col items-center slide-up" style="animation-delay: 0.2s">
          <div class="glass-card rounded-2xl p-8 card-hover w-full max-w-md"
               :class="{
                 'glow-effect': F3_EAP_Success_Rate > 80,
                 'glow-effect-yellow': F3_EAP_Success_Rate > 60 && F3_EAP_Success_Rate <= 80,
                 'glow-effect-red': F3_EAP_Success_Rate <= 60
               }">
            <h2 class="text-3xl font-bold mb-6 text-center bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">F3</h2>
            <div class="relative w-64 h-64 mx-auto mb-4">
              <svg class="w-full h-full transform -rotate-90" viewBox="0 0 256 256">
                <circle class="text-gray-300" stroke-width="16" stroke="currentColor" fill="none" cx="128" cy="128" r="110"/>
                <circle 
                  class="progress-circle"
                  :class="{
                    'text-red-500': F3_EAP_Success_Rate <= 60,
                    'text-yellow-400': F3_EAP_Success_Rate > 60 && F3_EAP_Success_Rate <= 80,
                    'text-green-400': F3_EAP_Success_Rate > 80
                  }"
                  stroke-width="16" 
                  stroke-linecap="round" 
                  stroke="currentColor" 
                  fill="none"
                  cx="128" cy="128" r="110"
                  :stroke-dasharray="2 * Math.PI * 110"
                  :stroke-dashoffset="(2 * Math.PI * 110) * (1 - F3_EAP_Success_Rate / 100)"/>
              </svg>
              <div class="absolute inset-0 flex flex-col items-center justify-center">
                <div class="text-4xl font-black text-gray-800">{{ F3_EAP_Success_Rate }}%</div>
                <div class="text-sm text-gray-600 mt-1">成功率</div>
              </div>
            </div>
          </div>
        </div>

        <!-- F5 進度圓 -->
        <div class="flex flex-col items-center slide-up" style="animation-delay: 0.4s">
          <div class="glass-card rounded-2xl p-8 card-hover w-full max-w-md"
               :class="{
                 'glow-effect': F5_EAP_Success_Rate > 80,
                 'glow-effect-yellow': F5_EAP_Success_Rate > 60 && F5_EAP_Success_Rate <= 80,
                 'glow-effect-red': F5_EAP_Success_Rate <= 60
               }">
            <h2 class="text-3xl font-bold mb-6 text-center bg-gradient-to-r from-emerald-600 to-green-600 bg-clip-text text-transparent">F5</h2>
            <div class="relative w-64 h-64 mx-auto mb-4">
              <svg class="w-full h-full transform -rotate-90" viewBox="0 0 256 256">
                <circle class="text-gray-300" stroke-width="16" stroke="currentColor" fill="none" cx="128" cy="128" r="110"/>
                <circle 
                  class="progress-circle"
                  :class="{
                    'text-red-500': F5_EAP_Success_Rate <= 60,
                    'text-yellow-400': F5_EAP_Success_Rate > 60 && F5_EAP_Success_Rate <= 80,
                    'text-green-400': F5_EAP_Success_Rate > 80
                  }"
                  stroke-width="16" 
                  stroke-linecap="round" 
                  stroke="currentColor" 
                  fill="none"
                  cx="128" cy="128" r="110"
                  :stroke-dasharray="2 * Math.PI * 110"
                  :stroke-dashoffset="(2 * Math.PI * 110) * (1 - F5_EAP_Success_Rate / 100)"/>
              </svg>
              <div class="absolute inset-0 flex flex-col items-center justify-center">
                <div class="text-4xl font-black text-gray-800">{{ F5_EAP_Success_Rate }}%</div>
                <div class="text-sm text-gray-600 mt-1">成功率</div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- 各樓層進度條區域 -->
      <div v-if="showEachFloor" class="glass-card rounded-2xl p-6 mb-12 fade-in">
        <div v-if="Object.keys(eachfloor).length === 0" class="text-center py-8 text-gray-500">
          <i data-lucide="database" class="w-12 h-12 mx-auto mb-3 text-gray-400"></i>
          <p class="text-lg">正在載入樓層資料...</p>
        </div>
        
        <div v-else>
          <div v-for="([groupName, group], groupIndex) in sortedEachFloor" :key="groupName" class="mb-8 last:mb-0">
            <div class="mb-6 text-gray-800 text-2xl font-bold flex justify-center">
              {{ groupName }}
            </div>
    
            <div class="grid" :style="'grid-template-columns: repeat(' + numColumns + ', 1fr); gap: 16px;'">
              <div v-for="([floor, data], index) in Object.entries(group)" :key="floor" class="group">
                <div class="flex flex-col items-start mb-2">
                  <div class="mb-2 text-gray-700 font-semibold text-base">{{ floor }}</div>
                </div>
                
                <div class="relative h-6 w-full bg-gray-200 rounded-md shadow-sm overflow-hidden">
                  <div 
                    class="absolute top-0 left-0 h-full rounded-md floor-progress-bar"
                    :style="{
                      width: data.Percent + '%',  
                      backgroundColor: getProgressStatus(data.Percent)
                    }">
                  </div>
    
                  <span class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-white font-bold text-xs drop-shadow-sm">
                    {{ data.Percent }}%
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 篩選按鈕控制區 - 只在表格上方 -->
      <div class="glass-card rounded-2xl p-4 mb-6 fade-in">
        <div class="flex flex-wrap items-center gap-3 justify-center">
          
          <!-- 樓層篩選按鈕 -->
          <button 
            @click="setFloorFilter('all')"
            class="inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm transition-all duration-300 transform hover:scale-105"
            :class="{
              'bg-amber-100 text-amber-700 border-2 border-amber-300': floorFilter === 'all',
              'bg-gray-100 text-gray-600 border-2 border-gray-200 hover:bg-gray-200': floorFilter !== 'all'
            }">
            <span>全部</span>
            <span class="bg-white/50 px-2 py-0.5 rounded text-xs">{{ totalCount }}</span>
          </button>
          
          <button 
            @click="setFloorFilter('F1')"
            class="inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm transition-all duration-300 transform hover:scale-105"
            :class="{
              'bg-blue-100 text-blue-700 border-2 border-blue-300': floorFilter === 'F1',
              'bg-gray-100 text-gray-600 border-2 border-gray-200 hover:bg-gray-200': floorFilter !== 'F1'
            }">
            <span>F1</span>
            <span class="bg-white/50 px-2 py-0.5 rounded text-xs">{{ f1Count }}</span>
          </button>
          
          <button 
            @click="setFloorFilter('F3')"
            class="inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm transition-all duration-300 transform hover:scale-105"
            :class="{
              'bg-purple-100 text-purple-700 border-2 border-purple-300': floorFilter === 'F3',
              'bg-gray-100 text-gray-600 border-2 border-gray-200 hover:bg-gray-200': floorFilter !== 'F3'
            }">
            <span>F3</span>
            <span class="bg-white/50 px-2 py-0.5 rounded text-xs">{{ f3Count }}</span>
          </button>
          
          <button 
            @click="setFloorFilter('F5')"
            class="inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm transition-all duration-300 transform hover:scale-105"
            :class="{
              'bg-green-100 text-green-700 border-2 border-green-300': floorFilter === 'F5',
              'bg-gray-100 text-gray-600 border-2 border-gray-200 hover:bg-gray-200': floorFilter !== 'F5'
            }">
            <span>F5</span>
            <span class="bg-white/50 px-2 py-0.5 rounded text-xs">{{ f5Count }}</span>
          </button>
          
          <!-- Alive/Dead 切換按鈕 -->
          <button 
            @click="toggleAliveDeadFilter"
            class="inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm transition-all duration-300 transform hover:scale-105"
            :class="{
              'bg-green-100 text-green-700 border-2 border-green-300': aliveDeadFilter === 'alive',
              'bg-red-100 text-red-700 border-2 border-red-300': aliveDeadFilter === 'dead',
              'bg-gray-100 text-gray-700 border-2 border-gray-300': aliveDeadFilter === 'all'
            }">
            <div class="w-2 h-2 rounded-full"
                 :class="{
                   'bg-green-500': aliveDeadFilter === 'alive',
                   'bg-red-500': aliveDeadFilter === 'dead',
                   'bg-gray-500': aliveDeadFilter === 'all'
                 }"></div>
            <span>{{ aliveDeadFilterText }}</span>
            <span class="bg-white/50 px-2 py-0.5 rounded text-xs">{{ aliveDeadCount }}</span>
          </button>

        </div>
      </div>

      <!-- 資料表格區域 -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 fade-in">
        <div v-for="(group, gIdx) in groupedData" :key="'g-'+gIdx" 
             class="glass-card rounded-2xl overflow-hidden card-hover">
          
          <!-- 表格標題 -->
          <div class="bg-gradient-to-r from-gray-100 to-gray-50 px-4 py-2 border-b border-gray-200">
            <div class="grid grid-cols-3 text-sm font-semibold text-gray-700">
              <div class="text-center flex items-center justify-center gap-2">
                <i data-lucide="globe" class="w-4 h-4 text-blue-600"></i>
                IP 位址
              </div>
              <div class="text-center flex items-center justify-center gap-2">
                <i data-lucide="server" class="w-4 h-4 text-purple-600"></i>
                機器 ID
              </div>
              <div class="text-center flex items-center justify-center gap-2">
                <i data-lucide="activity" class="w-4 h-4 text-emerald-600"></i>
                狀態
              </div>
            </div>
          </div>
          
          <!-- 表格內容 -->
          <div class="p-2">
            <div v-for="(row, idx) in group" :key="'g-'+gIdx+'-r-'+idx"
                 class="table-row grid grid-cols-3 items-center text-sm py-1.5 px-2 rounded-lg min-h-[26px]">
              <div class="font-mono text-blue-700 text-center line-clip-1 font-medium">
                {{ row ? (row.ip || row.Internal_IP || '-') : '' }}
              </div>
              <div class="text-gray-700 text-center line-clip-1">
                {{ row ? (row.machine_id || row.Machine_ID || '無資料') : '' }}
              </div>
              <div class="text-center">
                <template v-if="row">
                  <span class="status-badge inline-flex items-center gap-1 px-3 py-1.5 rounded-full text-xs font-medium"
                        :class="{
                          'bg-green-100 text-green-700 border border-green-300': isAlive(row.status || row.alive_or_dead),
                          'bg-red-100 text-red-700 border border-red-300': isDead(row.status || row.alive_or_dead),
                          'bg-gray-100 text-gray-700 border border-gray-300': !isAlive(row.status || row.alive_or_dead) && !isDead(row.status || row.alive_or_dead)
                        }">
                    <div class="w-2 h-2 rounded-full"
                         :class="{
                           'bg-green-500 pulse-animation': isAlive(row.status || row.alive_or_dead),
                           'bg-red-500': isDead(row.status || row.alive_or_dead),
                           'bg-gray-500': !isAlive(row.status || row.alive_or_dead) && !isDead(row.status || row.alive_or_dead)
                         }"></div>
                    {{ row.status || row.alive_or_dead || 'unknown' }}
                  </span>
                </template>
                <template v-else>
                  <span class="opacity-0">.</span>
                </template>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 分頁控制 -->
      <div v-if="totalPages > 1" class="flex items-center justify-center gap-6 mt-12 fade-in">
        <button @click="prevPage" 
                class="flex items-center gap-2 px-6 py-3 glass-card rounded-xl hover:bg-white/60 transition-all duration-300 transform hover:scale-105 shadow-lg">
          <i data-lucide="chevron-left" class="w-5 h-5"></i> 上一頁
        </button>
        
        <div class="flex items-center gap-4">
          <div class="text-lg text-gray-700">
            第 <span class="font-bold text-amber-600 text-xl">{{ currentPage }}</span> / 
            <span class="font-bold text-amber-600 text-xl">{{ totalPages }}</span> 頁
          </div>
        </div>
        
        <button @click="nextPage" 
                class="flex items-center gap-2 px-6 py-3 glass-card rounded-xl hover:bg-white/60 transition-all duration-300 transform hover:scale-105 shadow-lg">
          下一頁 <i data-lucide="chevron-right" class="w-5 h-5"></i>
        </button>
      </div>
    </template>

  </div>

  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
            allData: [],
            currentPage: 1,
            perPage: 45,
            loading: true,
            error: '',
            
            // 手動載入狀態
            manualLoading: false,
            
            // 圓形進度資料
            F1_EAP_Success_Rate: 0,
            F3_EAP_Success_Rate: 0,
            F5_EAP_Success_Rate: 0,
            
            // 顯示各樓層進度條
            showEachFloor: false,
            
            // 各樓層資料
            eachfloor: {},
            
            // 每行顯示的欄數
            numColumns: 4,
            
            // 篩選狀態
            aliveDeadFilter: 'all', // 'all', 'alive', 'dead'
            floorFilter: 'all', // 'all', 'F1', 'F3', 'F5'
        }
      },
      computed: {
        // 篩選後的資料
        filteredData() {
          let filtered = this.allData;
          
          // 按狀態篩選
          if (this.aliveDeadFilter !== 'all') {
            filtered = filtered.filter(item => {
              const status = item.status || item.alive_or_dead;
              if (this.aliveDeadFilter === 'alive') {
                return this.isAlive(status);
              } else if (this.aliveDeadFilter === 'dead') {
                return this.isDead(status);
              }
            });
          }
          
          // 按樓層篩選
          if (this.floorFilter !== 'all') {
            filtered = filtered.filter(item => {
              const filePlace = item.File_Place || '';
              return this.getFloorFromFilePlace(filePlace) === this.floorFilter;
            });
          }
          
          return filtered;
        },
        
        totalPages() {
          return Math.max(1, Math.ceil(this.filteredData.length / this.perPage));
        },
        paginatedData() {
          const start = (this.currentPage - 1) * this.perPage;
          return this.filteredData.slice(start, start + this.perPage);
        },
        groupedData() {
          const out = [];
          const src = this.paginatedData;
          for (let gi = 0; gi < 3; gi++) {
            const start = gi * 15;
            const chunk = src.slice(start, start + 15);
            if (chunk.length > 0) {
              while (chunk.length < 15) chunk.push(null);
              out.push(chunk);
            }
          }
          return out;
        },
        
        // 排序後的樓層資料
        sortedEachFloor() {
          if (!this.eachfloor || Object.keys(this.eachfloor).length === 0) {
            return [];
          }
          
          return Object.entries(this.eachfloor).map(([groupName, group]) => {
            const sortedGroup = Object.entries(group).sort((a, b) => {
              // 處理不同格式的樓層名稱
              const extractNumbers = (floorName) => {
                const match = floorName.match(/([A-Z]\d+)-(\d+)([A-Z]?)/);
                if (match) {
                  return {
                    building: match[1], // K11, K12 等
                    floor: parseInt(match[2]), // 樓層數字
                    suffix: match[3] || '' // 後綴字母
                  };
                }
                return { building: floorName, floor: 0, suffix: '' };
              };

              const floorA = extractNumbers(a[0]);
              const floorB = extractNumbers(b[0]);

              // 先按建築物排序
              if (floorA.building !== floorB.building) {
                return floorA.building.localeCompare(floorB.building);
              }

              // 再按樓層數字排序
              if (floorA.floor !== floorB.floor) {
                return floorA.floor - floorB.floor;
              }

              // 最後按後綴排序
              return floorA.suffix.localeCompare(floorB.suffix);
            });

            return [groupName, Object.fromEntries(sortedGroup)];
          });
        },
        
        // 統計數量
        aliveDeadFilterText() {
          switch(this.aliveDeadFilter) {
            case 'alive': return 'Alive';
            case 'dead': return 'Dead';
            default: return 'All';
          }
        },
        
        aliveDeadCount() {
          if (this.aliveDeadFilter === 'alive') {
            return this.allData.filter(item => this.isAlive(item.status || item.alive_or_dead)).length;
          } else if (this.aliveDeadFilter === 'dead') {
            return this.allData.filter(item => this.isDead(item.status || item.alive_or_dead)).length;
          }
          return this.allData.length;
        },
        
        f1Count() {
          return this.allData.filter(item => this.getFloorFromFilePlace(item.File_Place || '') === 'F1').length;
        },
        
        f3Count() {
          return this.allData.filter(item => this.getFloorFromFilePlace(item.File_Place || '') === 'F3').length;
        },
        
        f5Count() {
          return this.allData.filter(item => this.getFloorFromFilePlace(item.File_Place || '') === 'F5').length;
        },
        
        totalCount() {
          return this.allData.length;
        },
      },
      methods: {
        isAlive(v){ return (v||'').toString().trim().toLowerCase()==='alive'; },
        isDead(v){ return (v||'').toString().trim().toLowerCase()==='dead'; },
        
        prevPage() {
          if (this.totalPages <= 1) return;
          this.currentPage = this.currentPage > 1 ? this.currentPage - 1 : this.totalPages;
          this.saveFilterState(); // 保存狀態
        },
        nextPage() {
          if (this.totalPages <= 1) return;
          this.currentPage = this.currentPage < this.totalPages ? this.currentPage + 1 : 1;
          this.saveFilterState(); // 保存狀態
        },
        
        // 獲取歲修圓形進度資料
        async get_suixiu_data_circle(){
            try {
                const response = await fetch('http://127.0.0.1:5000/get_suixiu_circle_data');
                if (response.ok) {
                    const data = await response.json();
                    console.log('取得歲修圓形資料:', data);
                    
                    // 使用動畫更新進度值
                    this.animateProgress('F1_EAP_Success_Rate', data.total_data["F1"]["Percent"]);
                    this.animateProgress('F3_EAP_Success_Rate', data.total_data["F3"]["Percent"]);
                    this.animateProgress('F5_EAP_Success_Rate', data.total_data["F5"]["Percent"]);
                } else {
                    console.error('Error fetching circle data');
                }
            } catch (error) {
                console.error('Request failed', error);
            }
        },
        
        // 獲取各樓層資料
        async get_suixiu_EachFloor() {
            try {
                const response = await fetch('http://127.0.0.1:5000/get_suixiu_EachFloor');
                if (response.ok) {
                    const result = await response.json();
                    this.eachfloor = result.eachfloor || {};
                    console.log('各樓層資料:', this.eachfloor);
                } else {
                    console.error('Error fetching each floor data');
                    this.eachfloor = {};
                }
            } catch (error) {
                console.error('Request failed', error);
                this.eachfloor = {};
            }
        },
        
        // 根據百分比取得進度條顏色
        getProgressStatus(percentage) {
          if (percentage <= 30) {
            return '#EF4444'; // 紅色
          } else if (percentage > 30 && percentage <= 75) {
            return '#F59E0B'; // 橙色
          } else {
            return '#10B981'; // 綠色
          }
        },
        
        animateProgress(property, targetValue) {
          const duration = 2000;
          const startValue = this[property];
          const difference = targetValue - startValue;
          const startTime = performance.now();
          
          const animate = (currentTime) => {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            
            const easeOutQuart = 1 - Math.pow(1 - progress, 4);
            this[property] = Math.round(startValue + (difference * easeOutQuart));
            
            if (progress < 1) {
              requestAnimationFrame(animate);
            }
          };
          
          requestAnimationFrame(animate);
        },
        
        // 載入表格資料
        async fetchData() {
          this.loading = true; 
          this.error = '';
          try {
            const res = await axios.get('http://127.0.0.1:5000/show_suixiu_card');
            if (Array.isArray(res.data)) {
              this.allData = res.data;
              
              // 載入完成後恢復頁數，但確保不超出總頁數
              this.$nextTick(() => {
                const savedState = localStorage.getItem('suixiu_filter_state');
                if (savedState) {
                  try {
                    const filterState = JSON.parse(savedState);
                    const savedPage = filterState.currentPage || 1;
                    this.currentPage = Math.min(savedPage, this.totalPages);
                  } catch (e) {
                    this.currentPage = 1;
                  }
                } else {
                  this.currentPage = 1;
                }
              });
            } else {
              this.error = res.data?.error || '讀取資料失敗';
            }
          } catch (e) {
            this.error = '連線/讀取失敗（請檢查後端與 CORS 設定）';
            console.error(e);
          } finally {
            this.loading = false;
          }
        },
        
        // 重新載入所有資料
        reload(){ 
          this.fetchData(); 
          this.get_suixiu_data_circle();
          this.get_suixiu_EachFloor();
        },
        
        // 手動重新載入（有載入動畫）
        async manualReload() {
          if (this.manualLoading) return; // 防止重複點擊
          
          this.manualLoading = true;
          try {
            // 同時執行所有載入操作
            await Promise.all([
              this.fetchDataQuiet(), // 靜默載入表格資料
              this.get_suixiu_data_circle(),
              this.get_suixiu_EachFloor()
            ]);
            
            // 顯示成功提示（可選）
            console.log('手動重新載入完成');
          } catch (error) {
            console.error('手動重新載入失敗:', error);
            this.error = '重新載入失敗，請稍後再試';
          } finally {
            this.manualLoading = false;
          }
        },
        
        // 靜默載入表格資料（不顯示全域載入動畫）
        async fetchDataQuiet() {
          try {
            const res = await axios.get('http://127.0.0.1:5000/show_suixiu_card');
            if (Array.isArray(res.data)) {
              this.allData = res.data;
              
              // 載入完成後恢復頁數，但確保不超出總頁數
              this.$nextTick(() => {
                const savedState = localStorage.getItem('suixiu_filter_state');
                if (savedState) {
                  try {
                    const filterState = JSON.parse(savedState);
                    const savedPage = filterState.currentPage || 1;
                    this.currentPage = Math.min(savedPage, this.totalPages);
                  } catch (e) {
                    this.currentPage = 1;
                  }
                } else {
                  this.currentPage = 1;
                }
              });
            } else {
              this.error = res.data?.error || '讀取資料失敗';
            }
          } catch (e) {
            this.error = '連線/讀取失敗（請檢查後端與 CORS 設定）';
            console.error(e);
            throw e; // 重新拋出錯誤以便 manualReload 處理
          }
        },
        
        // 返回上一頁
        goBack() {
          if (window.history.length > 1) {
            window.history.back();
          } else {
            // 如果沒有瀏覽歷史，可以導向到首頁或其他預設頁面
            window.location.href = '/';
          }
        },
        
        // 切換顯示模式
        toggleFloorView() {
          this.showEachFloor = !this.showEachFloor;
          this.saveFilterState(); // 保存狀態
        },

        goToPostingRateDetail() {
            // ⚡ 這邊你可以改成要跳轉的網址或 Vue Router
          window.location.href = "postMCID.html";
        },
                
        // 篩選相關方法
        toggleAliveDeadFilter() {
          const states = ['all', 'alive', 'dead'];
          const currentIndex = states.indexOf(this.aliveDeadFilter);
          this.aliveDeadFilter = states[(currentIndex + 1) % states.length];
          this.currentPage = 1; // 重置到第一頁
          this.saveFilterState(); // 保存狀態
        },
        
        setFloorFilter(floor) {
          this.floorFilter = floor;
          this.currentPage = 1; // 重置到第一頁
          this.saveFilterState(); // 保存狀態
        },
        
        // 保存篩選狀態到 localStorage
        saveFilterState() {
          const filterState = {
            aliveDeadFilter: this.aliveDeadFilter,
            floorFilter: this.floorFilter,
            showEachFloor: this.showEachFloor,
            currentPage: this.currentPage
          };
          localStorage.setItem('suixiu_filter_state', JSON.stringify(filterState));
          console.log('篩選狀態已保存:', filterState);
        },
        
        // 從 localStorage 載入篩選狀態
        loadFilterState() {
          try {
            const savedState = localStorage.getItem('suixiu_filter_state');
            if (savedState) {
              const filterState = JSON.parse(savedState);
              this.aliveDeadFilter = filterState.aliveDeadFilter || 'all';
              this.floorFilter = filterState.floorFilter || 'all';
              this.showEachFloor = filterState.showEachFloor || false;
              // currentPage 會在資料載入後重新計算，先不設置
              console.log('篩選狀態已載入:', filterState);
            }
          } catch (error) {
            console.error('載入篩選狀態失敗:', error);
            // 如果載入失敗，使用預設值
            this.aliveDeadFilter = 'all';
            this.floorFilter = 'all';
            this.showEachFloor = false;
          }
        },
        
        // 帶記憶功能的重新載入
        async reloadWithMemory() {
          // 先保存當前狀態
          this.saveFilterState();
          
          // 重新載入資料
          await this.fetchData();
          await this.get_suixiu_data_circle();
          await this.get_suixiu_EachFloor();
          
          console.log('重新載入完成，篩選狀態已保持');
        },
        
        // 根據 File_Place 判斷樓層
        getFloorFromFilePlace(filePlace) {
          if (!filePlace) return 'unknown';
          
          const upperPlace = filePlace.toUpperCase();
          
          // K21, K22 為 F1
          if (upperPlace.includes('K21') || upperPlace.includes('K22')) {
            return 'F1';
          }
          
          // K11, K25 為 F3  
          if (upperPlace.includes('K11') || upperPlace.includes('K25')) {
            return 'F3';
          }
          
          // K18 為 F5
          if (upperPlace.includes('K18')) {
            return 'F5';
          }
          
          return 'unknown';
        },
        
        handleKeydown(e){
          if (e.key === 'ArrowLeft') this.prevPage();
          if (e.key === 'ArrowRight') this.nextPage();
          if (e.key === 'r' || e.key === 'R') this.manualReload();
          if (e.key === 'Escape') this.goBack();
        }
      },
      mounted() {
        // 先載入保存的篩選狀態
        this.loadFilterState();
        
        // 然後載入資料
        this.fetchData();
        this.get_suixiu_data_circle();
        this.get_suixiu_EachFloor();
        
        lucide.createIcons();
        window.addEventListener('keydown', this.handleKeydown, false);
      },
      updated(){ 
        lucide.createIcons(); 
      },
      beforeUnmount(){ 
        window.removeEventListener('keydown', this.handleKeydown, false); 
      }
    }).mount('#app');
  </script>
</body>
</html>