<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>設備狀態時序圖</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3.3.4/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>
<body class="bg-gray-100">
    <div id="app">
        <div class="container mx-auto px-4 py-8">
            <!-- 標題 -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h1 class="text-3xl font-bold text-gray-800 text-center">設備狀態時序圖</h1>
                <p class="text-center text-gray-600 mt-2">狀態持續時間視覺化</p>
            </div>

            <!-- 載入狀態 -->
            <div v-if="loading" class="bg-white rounded-lg shadow-md p-8 text-center">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                <p class="mt-4 text-gray-600">載入中...</p>
            </div>

            <!-- 錯誤訊息 -->
            <div v-if="error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-6">
                {{ error }}
            </div>

            <!-- 圖例 -->
            <div v-if="!loading && !error" class="bg-white rounded-lg shadow-md p-4 mb-6">
                <div class="flex justify-center gap-6">
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 bg-red-500 rounded"></div>
                        <span class="text-gray-700 font-medium">ALARM (警報)</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 bg-green-500 rounded"></div>
                        <span class="text-gray-700 font-medium">BUSY (忙碌)</span>
                    </div>
                </div>
            </div>

            <!-- Building 和 Floor 篩選 -->
            <div v-if="!loading && !error" class="bg-white rounded-lg shadow-md p-4 mb-6">
                <h3 class="font-semibold text-gray-800 mb-3">設備位置篩選</h3>
                <div class="flex flex-wrap items-end gap-3">
                    <div class="flex-1 min-w-[150px]">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Building</label>
                        <select v-model="selectedBuilding" @change="onLocationChange"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">全部</option>
                            <option v-for="building in availableBuildings" :key="building" :value="building">
                                {{ building }}
                            </option>
                        </select>
                    </div>
                    <div class="flex-1 min-w-[150px]">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Floor</label>
                        <select v-model="selectedFloor" @change="onLocationChange"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">全部</option>
                            <option v-for="floor in availableFloors" :key="floor" :value="floor">
                                {{ floor }}
                            </option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- 時間篩選 -->
            <div v-if="!loading && !error" class="bg-white rounded-lg shadow-md p-4 mb-6">
                <h3 class="font-semibold text-gray-800 mb-3">時間範圍篩選</h3>
                
                <!-- 快速選擇按鈕 -->
                <div class="flex flex-wrap gap-2 mb-4">
                    <button @click="selectQuickRange(1)" 
                            class="px-4 py-2 rounded-lg font-medium transition-all"
                            :class="quickRange === 1 ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'">
                        24小時
                    </button>
                    <button @click="selectQuickRange(7)" 
                            class="px-4 py-2 rounded-lg font-medium transition-all"
                            :class="quickRange === 7 ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'">
                        7天
                    </button>
                    <button @click="selectQuickRange(30)" 
                            class="px-4 py-2 rounded-lg font-medium transition-all"
                            :class="quickRange === 30 ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'">
                        30天
                    </button>
                    <button @click="selectQuickRange(null)" 
                            class="px-4 py-2 rounded-lg font-medium transition-all"
                            :class="quickRange === null ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'">
                        全部
                    </button>
                </div>
                
                <!-- 自訂日期範圍 -->
                <div class="border-t pt-4">
                    <div class="flex flex-wrap items-end gap-3">
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-sm font-medium text-gray-700 mb-1">開始日期</label>
                            <input type="date" v-model="customStartDate" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-sm font-medium text-gray-700 mb-1">結束日期</label>
                            <input type="date" v-model="customEndDate" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <button @click="applyCustomRange" 
                                class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium transition-all">
                            查詢
                        </button>
                        <button @click="resetFilter" 
                                class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 font-medium transition-all">
                            重置
                        </button>
                    </div>
                </div>
            </div>

            <!-- 圖表 -->
            <div v-if="!loading && !error" class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="relative" :style="{ height: chartHeight + 'px' }">
                    <canvas ref="chartCanvas"></canvas>
                </div>
            </div>

            <!-- 統計資訊 -->
            <div v-if="!loading && !error && stats" class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">統計資訊</h2>
                
                <!-- 設備選擇按鈕 -->
                <div class="flex gap-3 mb-6 flex-wrap">
                    <button v-for="station in Object.keys(stats)" :key="station"
                            @click="selectedStation = station"
                            class="px-4 py-2 rounded-lg font-medium transition-all"
                            :class="selectedStation === station 
                                ? 'bg-blue-600 text-white shadow-md' 
                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'">
                        {{ station }}
                    </button>
                </div>
                
                <!-- 顯示選中設備的資訊 -->
                <div v-if="selectedStation && stats[selectedStation]" class="border border-gray-200 rounded-lg p-4">
                    <h3 class="font-bold text-xl text-gray-800 mb-4 pb-2 border-b">{{ selectedStation }}</h3>
                    
                    <!-- 總計 -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="bg-red-50 rounded-lg p-3">
                            <div class="flex items-center gap-2 mb-1">
                                <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                                <span class="font-semibold text-gray-800">ALARM 總計</span>
                            </div>
                            <div class="text-sm text-gray-700">
                                {{ stats[selectedStation].ALARM.count }} 次，{{ stats[selectedStation].ALARM.totalMinutes.toFixed(0) }} 分鐘 ({{ stats[selectedStation].ALARM.hours }}h)
                            </div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-3">
                            <div class="flex items-center gap-2 mb-1">
                                <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                <span class="font-semibold text-gray-800">BUSY 總計</span>
                            </div>
                            <div class="text-sm text-gray-700">
                                {{ stats[selectedStation].BUSY.count }} 次，{{ stats[selectedStation].BUSY.totalMinutes.toFixed(0) }} 分鐘 ({{ stats[selectedStation].BUSY.hours }}h)
                            </div>
                        </div>
                    </div>
                    
                    <!-- 詳細時間列表 -->
                    <div class="mt-4">
                        <h4 class="font-semibold text-gray-700 mb-2">詳細時間記錄：</h4>
                        <div class="max-h-96 overflow-y-auto space-y-1 text-sm">
                            <div v-for="(item, index) in stats[selectedStation].timeline" :key="index" 
                                 class="flex items-center justify-between p-2 rounded hover:bg-gray-50"
                                 :class="item.status === 'ALARM' ? 'border-l-4 border-red-500' : 'border-l-4 border-green-500'">
                                <div class="flex items-center gap-2">
                                    <div class="w-2 h-2 rounded-full" 
                                         :class="item.status === 'ALARM' ? 'bg-red-500' : 'bg-green-500'"></div>
                                    <span class="font-medium" :class="item.status === 'ALARM' ? 'text-red-700' : 'text-green-700'">
                                        {{ item.status }}
                                    </span>
                                </div>
                                <div class="flex items-center gap-3 text-gray-600">
                                    <span>{{ item.startFormatted }}</span>
                                    <span>→</span>
                                    <span>{{ item.endFormatted }}</span>
                                    <span class="text-gray-500">({{ item.duration }}分)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>